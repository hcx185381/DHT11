<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸŒ è¿œç¨‹æ¸©æ¹¿åº¦ç›‘æµ‹ (MQTTå®æ—¶)</title>
    <!-- å¼•å…¥ MQTT.js åº“ [citation:10] -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-weight: 300;
            border-bottom: 2px solid #764ba2;
            padding-bottom: 10px;
        }
        .status {
            color: #28a745;
            font-size: 0.9rem;
            margin-bottom: 20px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 20px;
            display: inline-block;
        }
        .data-item {
            margin: 25px 0;
        }
        .label {
            font-size: 1.2rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .value {
            font-size: 4rem;
            font-weight: bold;
            color: #764ba2;
            line-height: 1.2;
        }
        .unit {
            font-size: 1.5rem;
            color: #999;
            margin-left: 5px;
        }
        .footer {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #aaa;
        }
        .update-time {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>ğŸŒ¡ï¸ è¿œç¨‹æ¸©æ¹¿åº¦ç›‘æµ‹</h1>
    <div class="status" id="mqtt-status">â³ è¿æ¥ä¸­...</div>
    
    <div class="data-item">
        <div class="label">æ¸©åº¦</div>
        <span class="value" id="temp-value">--</span><span class="unit">Â°C</span>
    </div>
    
    <div class="data-item">
        <div class="label">æ¹¿åº¦</div>
        <span class="value" id="hum-value">--</span><span class="unit">%</span>
    </div>
    
    <div class="update-time" id="last-update">ç­‰å¾…æ•°æ®...</div>
    <div class="footer">ESP32-C3 æ— çº¿ä¼ æ„Ÿå™¨ Â· MQTTå®æ—¶æ•°æ®</div>
</div>

<script>
    // MQTT é…ç½® [citation:5][citation:10]
    const brokerUrl = 'wss://broker.emqx.io:8084/mqtt';  // WebSocketå®‰å…¨è¿æ¥
    const options = {
        clean: true,
        connectTimeout: 4000,
        clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
        // å…¬å…±brokeré€šå¸¸ä¸éœ€è¦ç”¨æˆ·åå¯†ç ï¼Œå¦‚æœ‰éœ€è¦å¯é…ç½® [citation:10]
    };

    console.log('æ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨:', brokerUrl);
    const client = mqtt.connect(brokerUrl, options);

    // è¿æ¥æˆåŠŸå›è°ƒ
    client.on('connect', function() {
        console.log('MQTTè¿æ¥æˆåŠŸ');
        document.getElementById('mqtt-status').innerHTML = 'âœ… å·²è¿æ¥åˆ°äº‘ç«¯';
        document.getElementById('mqtt-status').style.color = '#28a745';
        
        // è®¢é˜…æ¸©æ¹¿åº¦ä¸»é¢˜ [citation:7]
        client.subscribe('home/esp32c3/temperature', function(err) {
            if (!err) {
                console.log('å·²è®¢é˜…æ¸©åº¦ä¸»é¢˜');
            }
        });
        client.subscribe('home/esp32c3/humidity', function(err) {
            if (!err) {
                console.log('å·²è®¢é˜…æ¹¿åº¦ä¸»é¢˜');
            }
        });
    });

    // æ¥æ”¶æ¶ˆæ¯å›è°ƒ [citation:5]
    client.on('message', function(topic, message) {
        const value = message.toString();
        console.log('æ”¶åˆ°æ¶ˆæ¯:', topic, value);
        
        // æ ¹æ®ä¸»é¢˜æ›´æ–°å¯¹åº”çš„æ˜¾ç¤º
        if (topic === 'home/esp32c3/temperature') {
            document.getElementById('temp-value').textContent = value;
        } else if (topic === 'home/esp32c3/humidity') {
            document.getElementById('hum-value').textContent = value;
        }
        
        // æ›´æ–°æœ€åæ¥æ”¶æ—¶é—´
        const now = new Date();
        document.getElementById('last-update').innerHTML = 
            'æœ€åæ›´æ–°: ' + now.toLocaleTimeString();
    });

    // è¿æ¥é”™è¯¯å›è°ƒ
    client.on('error', function(err) {
        console.error('è¿æ¥é”™è¯¯:', err);
        document.getElementById('mqtt-status').innerHTML = 'âŒ è¿æ¥å¤±è´¥';
        document.getElementById('mqtt-status').style.color = '#dc3545';
    });

    // æ–­å¼€è¿æ¥å›è°ƒ
    client.on('close', function() {
        console.log('MQTTè¿æ¥å·²æ–­å¼€');
        document.getElementById('mqtt-status').innerHTML = 'âš ï¸ è¿æ¥å·²æ–­å¼€';
        document.getElementById('mqtt-status').style.color = '#ffc107';
    });
</script>
</body>
</html>
